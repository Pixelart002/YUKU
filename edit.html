<script>
    document.addEventListener('DOMContentLoaded', () => {
        let authToken = null;
        const app = {
            config: {
                API_BASE_URL: 'https://magnetic-murielle-pixelart002-829a755b.koyeb.app'
            },
            elements: {
                authPage: document.getElementById('auth-page'),
                dashboardPage: document.getElementById('dashboard-page'),
                loginForm: document.getElementById('login-form'),
                loginFormAction: document.getElementById('loginFormAction'),
                signupForm: document.getElementById('signup-form'),
                signupFormAction: document.getElementById('signupFormAction'),
                // --- NEW ---
                forgotPasswordForm: document.getElementById('forgot-password-form'),
                forgotPasswordFormAction: document.getElementById('forgotPasswordFormAction'),
                showForgotPasswordBtn: document.getElementById('show-forgot-password'),
                backToLoginBtn: document.getElementById('back-to-login'),
                // --- END NEW ---
                showSignupBtn: document.getElementById('show-signup'),
                showLoginBtn: document.getElementById('show-login'),
                logoutBtn: document.getElementById('logoutBtn'),
                authErrorBox: document.getElementById('auth-error-box'),
                hamburgerBtn: document.getElementById('hamburgerBtn'),
                closeBtn: document.getElementById('closeBtn'),
                sidebar: document.getElementById('sidebar'),
                overlay: document.getElementById('overlay'),
                navLinks: document.querySelectorAll('.nav-link'),
                contentPanels: document.querySelectorAll('.content-panel'),
                headerTitle: document.getElementById('header-title'),
                profileContainer: document.getElementById('profile-container'),
                profileBtn: document.getElementById('profile-btn'),
                profilePopup: document.getElementById('profile-popup'),
                profileInitials: document.getElementById('profile-initials'),
                popupName: document.getElementById('popup-name'),
                popupEmail: document.getElementById('popup-email'),
                timestamp: document.getElementById('timestamp'),
            },

            init() {
                this.addEventListeners();
                this.updateTimestamp();
                setInterval(() => this.updateTimestamp(), 1000);
            },

            addEventListeners() {
                const { elements } = this;
                elements.signupFormAction.addEventListener('submit', (e) => { e.preventDefault(); this.handleSignup(); });
                elements.loginFormAction.addEventListener('submit', (e) => { e.preventDefault(); this.handleLogin(); });
                elements.logoutBtn.addEventListener('click', (e) => { e.preventDefault(); this.showAuthPage(); });
                elements.showSignupBtn.addEventListener('click', (e) => { e.preventDefault(); this.toggleAuthForms('signup'); });
                elements.showLoginBtn.addEventListener('click', (e) => { e.preventDefault(); this.toggleAuthForms('login'); });
                
                // --- NEW ---
                elements.showForgotPasswordBtn.addEventListener('click', (e) => { e.preventDefault(); this.toggleAuthForms('forgot'); });
                elements.backToLoginBtn.addEventListener('click', (e) => { e.preventDefault(); this.toggleAuthForms('login'); });
                elements.forgotPasswordFormAction.addEventListener('submit', (e) => { e.preventDefault(); this.handleForgotPassword(); });
                // --- END NEW ---

                elements.hamburgerBtn.addEventListener('click', () => this.openSidebar());
                elements.closeBtn.addEventListener('click', () => this.closeSidebar());
                elements.overlay.addEventListener('click', () => this.closeSidebar());
                document.addEventListener('keydown', (e) => { if (e.key === 'Escape') this.closeSidebar(); });
                elements.navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.navigateTo(link.getAttribute('data-page'));
                        if (window.innerWidth < 768) this.closeSidebar();
                    });
                });
                elements.profileContainer.addEventListener('mouseenter', () => this.showProfilePopup());
                elements.profileContainer.addEventListener('mouseleave', () => this.hideProfilePopup());
                elements.profileBtn.addEventListener('click', () => { this.navigateTo('profile'); if (window.innerWidth < 768) this.closeSidebar(); });
            },
            
            async handleApiRequest(endpoint, body, button) {
                if(button) button.disabled = true;
                this.elements.authErrorBox.classList.add('hidden');
                try {
                    const response = await fetch(`${this.config.API_BASE_URL}/${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const data = await response.json();
                    if (!response.ok) { throw new Error(data.detail || 'An unknown error occurred.'); }
                    return data;
                } catch (error) {
                    this.showAuthError(error.message);
                    return null;
                } finally {
                    if(button) button.disabled = false;
                }
            },

            async handleSignup() {
                const button = this.elements.signupFormAction.querySelector('button');
                const fullname = document.getElementById('signup-fullname').value;
                const email = document.getElementById('signup-email-address').value;
                const password = document.getElementById('signup-password').value;
                const result = await this.handleApiRequest('signup', { fullname, email, password }, button);
                if (result) { this.handleLogin(email, password); }
            },

            async handleLogin(emailOverride = null, passwordOverride = null) {
                const button = this.elements.loginFormAction.querySelector('button');
                const email = emailOverride || document.getElementById('login-email-address').value;
                const password = passwordOverride || document.getElementById('login-password').value;
                const result = await this.handleApiRequest('login', { email, password }, button);
                if (result && result.user) {
                    authToken = result.token.access_token;
                    this.updateUserInfo(result.user);
                    this.showDashboard('yuku-ai');
                }
            },
            
            // --- NEW handleForgotPassword METHOD ---
            async handleForgotPassword() {
                const button = this.elements.forgotPasswordFormAction.querySelector('button');
                const email = document.getElementById('forgot-email-input').value;
                const messageEl = document.getElementById('forgot-message');
                messageEl.textContent = 'Processing...';
                messageEl.style.color = 'var(--text-secondary)';

                const result = await this.handleApiRequest('forgot-password', { email }, button);
                if (result) {
                    messageEl.textContent = result.message;
                    messageEl.style.color = 'var(--accent-green)';
                } else {
                    // handleApiRequest shows the error in authErrorBox, but we can add a specific message here too
                    messageEl.textContent = 'Failed. Please check the error message above.';
                    messageEl.style.color = 'red';
                }
            },
            // --- END NEW ---

            updateUserInfo(user) {
                const { fullname, email } = user;
                const initials = fullname.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                this.elements.profileInitials.textContent = initials;
                this.elements.popupName.textContent = fullname;
                this.elements.popupEmail.textContent = email;
            },

            showAuthError(message) {
                this.elements.authErrorBox.textContent = `[ERROR]: ${message}`;
                this.elements.authErrorBox.classList.remove('hidden');
            },

            showDashboard(defaultPage) {
                this.elements.authErrorBox.classList.add('hidden');
                this.elements.authPage.classList.replace('page-visible', 'page-hidden');
                this.elements.dashboardPage.classList.replace('page-hidden', 'page-visible');
                this.navigateTo(defaultPage);
            },

            showAuthPage() {
                authToken = null; // Clear token on logout
                this.closeSidebar();
                this.updateUserInfo({ fullname: '', email: '' });
                this.elements.loginFormAction.reset();
                this.elements.signupFormAction.reset();
                this.elements.forgotPasswordFormAction.reset(); // Clear forgot form too
                setTimeout(() => {
                    this.elements.dashboardPage.classList.replace('page-visible', 'page-hidden');
                    this.elements.authPage.classList.replace('page-hidden', 'page-visible');
                }, 300);
            },

            updateTimestamp() { this.elements.timestamp.textContent = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }); },

            navigateTo(pageId) {
                this.elements.contentPanels.forEach(p => p.classList.remove('active'));
                const contentContainer = document.getElementById(`${pageId}-content`);
                if (pageId === 'profile') {
                    this.fetchAndDisplayProfile();
                } else {
                    contentContainer.innerHTML = this.getPageContent(pageId);
                }
                contentContainer.classList.add('active');
                if (pageId === 'yuku-ai') { document.getElementById('ai-execute-btn').addEventListener('click', () => this.handleAiQuery()); }
                let activeLinkText = '';
                this.elements.navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('data-page') === pageId) {
                        link.classList.add('active');
                        activeLinkText = link.textContent.trim();
                    }
                });
                this.elements.headerTitle.textContent = activeLinkText;
            },

            async handleAiQuery() {
                const prompt = document.getElementById("ai-prompt-input").value;
                const responseContainer = document.getElementById("ai-response-container");
                const executeBtn = document.getElementById("ai-execute-btn");
                if (!prompt.trim()) {
                    responseContainer.innerHTML = "<p class='text-yellow-400'>[ERROR: Directive cannot be empty.]</p>";
                    return;
                }
                if (!authToken) {
                    responseContainer.innerHTML = "<p class='text-red-500'>[ERROR: Authentication required. Please log in again.]</p>";
                    return;
                }
                executeBtn.disabled = true;
                executeBtn.textContent = "Processing...";
                responseContainer.innerHTML = "<div class='flex items-center space-x-2'><div class='w-4 h-4 rounded-full animate-pulse bg-accent-green'></div><p class='text-text-secondary'>[TRANSMITTING TO YUKU CORE...]</p></div>";
                try {
                    const res = await fetch(`${this.config.API_BASE_URL}/ai/ask`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${authToken}` },
                        body: JSON.stringify({ prompt: prompt })
                    });
                    const data = await res.json();
                    if (!res.ok) { throw new Error(data.detail || `API call failed with status: ${res.status}`); }
                    const answer = data.response;
                    responseContainer.innerHTML = `<h5 class="font-orbitron text-accent-green">YUKU RESPONSE:</h5><p class="mt-2 whitespace-pre-wrap">${answer.trim()}</p>`;
                } catch (error) {
                    console.error("AI Core Error:", error);
                    responseContainer.innerHTML = `<p class='text-red-500'>[CONNECTION FAILED]: ${error.message}</p>`;
                } finally {
                    executeBtn.disabled = false;
                    executeBtn.textContent = "Execute";
                }
            },

            // --- UPDATED toggleAuthForms ---
            toggleAuthForms(formToShow = 'login') {
                this.elements.authErrorBox.classList.add("hidden");
                const { loginForm, signupForm, forgotPasswordForm } = this.elements;
                const allForms = [loginForm, signupForm, forgotPasswordForm];
                
                allForms.forEach(form => {
                    if (form.id.startsWith(formToShow)) {
                        form.classList.replace("form-hidden", "form-visible");
                    } else {
                        form.classList.replace("form-visible", "form-hidden");
                    }
                });
            },
            // --- END UPDATE ---
            
            openSidebar() { this.elements.sidebar.classList.remove('-translate-x-full'); this.elements.overlay.classList.remove('hidden'); },
            closeSidebar() { this.elements.sidebar.classList.add('-translate-x-full'); this.elements.overlay.classList.add('hidden'); this.hideProfilePopup(); },
            showProfilePopup() { this.elements.profilePopup.classList.remove('opacity-0', 'scale-95', 'pointer-events-none'); },
            hideProfilePopup() { this.elements.profilePopup.classList.add('opacity-0', 'scale-95', 'pointer-events-none'); },
            getPageContent(pageId) { const content = { 'yuku-ai': '<div class="glass-panel p-6 rounded-lg"><h3 class="text-2xl font-orbitron text-accent-green mb-4">AI CORE INTERFACE v2.5</h3><p class="text-text-secondary mb-4">Direct link established with Gemini-Flash. Input query below.</p><textarea id="ai-prompt-input" class="input-field w-full p-3 rounded-md" rows="6" placeholder="[Awaiting Directive...]"></textarea><button id="ai-execute-btn" class="tactical-btn mt-4 py-2 px-6 rounded-md">Execute</button><div id="ai-response-container" class="mt-6 glass-panel p-4 rounded-md min-h-[60px]"><p class="text-text-secondary">[GEMINI STATUS: STANDBY]</p></div></div>', dashboard: '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><div class="glass-panel p-4 rounded-lg"><h4 class="font-orbitron text-accent-green">GLOBAL STATUS</h4><p class="text-text-secondary">Systems Nominal</p></div><div class="glass-panel p-4 rounded-lg"><h4 class="font-orbitron text-accent-green">ACTIVE THREATS</h4><p class="text-text-secondary">0 Detected</p></div><div class="glass-panel p-4 rounded-lg"><h4 class="font-orbitron text-accent-green">TEAM SYNC</h4><p class="text-text-secondary">12 Agents Online</p></div></div>', profile: '<div class="glass-panel p-6 rounded-lg max-w-2xl mx-auto"><h3 class="text-2xl font-orbitron text-accent-green mb-4">AGENT DOSSIER</h3><p class="text-text-secondary">Review and update your operative credentials.</p></div>', settings: '<div class="glass-panel p-6 rounded-lg max-w-2xl mx-auto"><h3 class="text-2xl font-orbitron text-accent-green mb-4">SYSTEM CALIBRATION</h3><p class="text-text-secondary">Adjust interface parameters and security protocols.</p></div>' }; return content[pageId] || '<p>Content not found.</p>'; },
            
            async fetchAndDisplayProfile() {
                const contentContainer = document.getElementById('profile-content');
                if (!authToken) {
                    contentContainer.innerHTML = `<p class="text-red-500">[ERROR: Authentication token not found.]</p>`;
                    return;
                }
                try {
                    const response = await fetch(`${this.config.API_BASE_URL}/users/me`, {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (!response.ok) { throw new Error('Failed to fetch agent dossier.'); }
                    const userData = await response.json();
                    contentContainer.innerHTML = `
                        <div class="glass-panel p-6 rounded-lg max-w-2xl mx-auto">
                            <h3 class="text-2xl font-orbitron text-accent-green mb-6">AGENT DOSSIER</h3>
                            <div class="space-y-4">
                                <div><p class="text-sm text-text-secondary">FULL NAME</p><p class="text-lg text-text-primary">${userData.fullname}</p></div>
                                <div><p class="text-sm text-text-secondary">AGENT ID (EMAIL)</p><p class="text-lg text-text-primary">${userData.email}</p></div>
                                <div><p class="text-sm text-text-secondary">STATUS</p><p class="text-lg text-accent-green">ACTIVE</p></div>
                            </div>
                        </div>`;
                } catch (error) {
                    contentContainer.innerHTML = `<p class="text-red-500">[ERROR: ${error.message}]</p>`;
                }
            },
        };
        app.init();
    });
</script>
