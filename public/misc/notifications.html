<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Push Notifications Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen">
  <h1 class="text-2xl font-bold mb-6">ðŸš€ Web Push Notifications Demo</h1>

  <button id="subscribeBtn" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg">
    Enable Notifications
  </button>

  <button id="testBtn" class="px-6 py-2 mt-4 bg-green-600 hover:bg-green-500 rounded-lg">
    Send Test Notification
  </button>

  <script>
    const API_BASE_URL = "'https://open-feliza-pixelart002-78fb4fe8.koyeb.app"; // <-- replace with your backend URL

    // Base64 â†’ Uint8Array conversion (needed for VAPID public key)
    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    async function subscribeUser() {
      try {
        // Step 1: Register Service Worker
        const registration = await navigator.serviceWorker.register("/sw.js");
        console.log("Service Worker registered.");

        // Step 2: Get VAPID public key from backend
        const resp = await fetch(`${API_BASE_URL}/webpush/vapid-public-key`);
        const data = await resp.json();
        const publicKey = data.public_key;

        // Step 3: Ask for permission
        const permission = await Notification.requestPermission();
        if (permission !== "granted") {
          alert("Notifications blocked.");
          return;
        }

        // Step 4: Subscribe user
        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(publicKey),
        });

        console.log("Got subscription:", subscription);

        // Step 5: Send subscription to backend
        const saveResp = await fetch(`${API_BASE_URL}/webpush/subscribe`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(subscription),
        });

        if (saveResp.ok) {
          alert("Subscribed successfully!");
        } else {
          alert("Subscription failed.");
        }
      } catch (err) {
        console.error("Subscription error:", err);
      }
    }

    async function sendTest() {
      try {
        const resp = await fetch(`${API_BASE_URL}/webpush/send-test`, { method: "POST" });
        if (resp.ok) {
          alert("Test notification triggered from backend!");
        } else {
          alert("Failed to send test.");
        }
      } catch (err) {
        console.error("Error sending test:", err);
      }
    }

    document.getElementById("subscribeBtn").addEventListener("click", subscribeUser);
    document.getElementById("testBtn").addEventListener("click", sendTest);
  </script>
</body>
</html>