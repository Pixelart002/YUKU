<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 1000px; }
        .card { margin-bottom: 20px; }
        #apiResponse {
            background-color: #282c34;
            color: #9cdcfe;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .nav-tabs .nav-link { cursor: pointer; }
        .tab-pane { padding-top: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="mb-4">Store Management Dashboard</h1>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Controls</h5>
                <div class="mb-3">
                    <label for="authToken" class="form-label"><b>Auth Token (JWT)</b></label>
                    <input type="password" class="form-control" id="authToken" placeholder="Paste your Bearer token here">
                    <button class="btn btn-primary btn-sm mt-2" id="saveTokenBtn">Save Token</button>
                </div>
                <hr>
                <h5 class="card-title">API Response Log</h5>
                <pre id="apiResponse">API responses will appear here...</pre>
            </div>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">Products</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">Orders</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="discounts-tab" data-bs-toggle="tab" data-bs-target="#discounts" type="button" role="tab">Discounts</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ads-tab" data-bs-toggle="tab" data-bs-target="#ads" type="button" role="tab">Ads</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="catalog-tab" data-bs-toggle="tab" data-bs-target="#catalog" type="button" role="tab">Catalog</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="notify-tab" data-bs-toggle="tab" data-bs-target="#notify" type="button" role="tab">Notify</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="products" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Add Product (Auth Required)</h5>
                                <form id="addProductForm">
                                    <div class="mb-3"><input type="text" class="form-control" name="name" placeholder="Name" required></div>
                                    <div class="mb-3"><textarea class="form-control" name="description" placeholder="Description" required></textarea></div>
                                    <div class="mb-3"><input type="number" step="0.01" class="form-control" name="price" placeholder="Price" required></div>
                                    <div class="mb-3"><input type="number" class="form-control" name="stock" placeholder="Stock" required></div>
                                    <div class="mb-3"><input type="text" class="form-control" name="category" placeholder="Category (e.g., general)"></div>
                                    <div class="mb-3"><label class="form-label">Image</label><input type="file" class="form-control" name="image"></div>
                                    <button type="submit" class="btn btn-success">Add Product</button>
                                </form>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Update Product (Auth Required)</h5>
                                <form id="updateProductForm">
                                    <div class="mb-3"><input type="text" class="form-control" id="updateProductId" placeholder="Product ID to Update" required></div>
                                    <div class="mb-3"><input type="text" class="form-control" name="name" placeholder="New Name (Optional)"></div>
                                    <div class="mb-3"><textarea class="form-control" name="description" placeholder="New Description (Optional)"></textarea></div>
                                    <div class="mb-3"><input type="number" step="0.01" class="form-control" name="price" placeholder="New Price (Optional)"></div>
                                    <div class="mb-3"><input type="number" class="form-control" name="stock" placeholder="New Stock (Optional)"></div>
                                    <div class="mb-3"><input type="text" class="form-control" name="category" placeholder="New Category (Optional)"></div>
                                    <div class="mb-3"><label class="form-label">New Image (Optional)</label><input type="file" class="form-control" name="image"></div>
                                    <button type="submit" class="btn btn-warning">Update Product</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Manage Products</h5>
                                <button class="btn btn-primary" id="listProductsBtn">List All Products</button>
                                <hr>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="productIdInput" placeholder="Enter Product ID for actions">
                                    <button class="btn btn-info" id="getProductBtn">Get Details</button>
                                    <button class="btn btn-danger" id="deleteProductBtn">Delete (Auth)</button>
                                </div>
                                <hr>
                                <h5>Product List / Details</h5>
                                <div id="productsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="orders" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Create Order (Customer)</h5>
                                <form id="createOrderForm">
                                    <div class="mb-3"><input type="text" class="form-control" id="orderCustomerName" placeholder="Customer Name" required></div>
                                    <div class="mb-3"><input type="email" class="form-control" id="orderCustomerEmail" placeholder="Customer Email" required></div>
                                    <div class="mb-3"><input type="text" class="form-control" id="orderCustomerPhone" placeholder="Customer Phone" required></div>
                                    <div class="mb-3"><input type="text" class="form-control" id="orderAddress" placeholder="Address" required></div>
                                    <div class="mb-3">
                                        <label class="form-label">Products (JSON format)</label>
                                        <textarea class="form-control" id="orderProducts" rows="3" required>[{"product_id": "...", "quantity": 1}]</textarea>
                                    </div>
                                    <button type="submit" class="btn btn-success">Create Order</button>
                                </form>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Order Actions (Vendor Auth)</h5>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="orderIdInput" placeholder="Enter Order ID for actions">
                                    <button class="btn btn-info" id="getOrderBtn">Get Details (Auth)</button>
                                    <button class="btn btn-secondary" id="generateBillBtn">Generate Bill/QR</button>
                                </div>
                                <form id="updateOrderStatusForm" class="d-flex mb-3">
                                    <input type="text" class="form-control me-2" id="updateStatusOrderId" placeholder="Order ID">
                                    <select class="form-select me-2" id="orderStatusSelect">
                                        <option value="Pending">Pending</option>
                                        <option value="Shipped">Shipped</option>
                                        <option value="Delivered">Delivered</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </select>
                                    <button type="submit" class="btn btn-warning">Update Status (Auth)</button>
                                </form>
                                <div id="billQrCode"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Manage Orders (Vendor)</h5>
                                <button class="btn btn-primary" id="listMyOrdersBtn">List My Orders (Auth)</button>
                                <hr>
                                <h5>Order List / Details</h5>
                                <div id="ordersList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="discounts" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Add Discount</h5>
                                <form id="addDiscountForm">
                                    <div class="mb-3"><input type="text" class="form-control" id="discountCode" placeholder="Discount Code" required></div>
                                    <div class="mb-3"><input type="number" step="0.1" class="form-control" id="discountPercentage" placeholder="Percentage (e.g., 10.5)" required></div>
                                    <div class="mb-3"><label class="form-label">Valid Until (Optional)</label><input type="datetime-local" class="form-control" id="discountValidUntil"></div>
                                    <button type="submit" class="btn btn-success">Add Discount</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Manage Discounts</h5>
                                <button class="btn btn-primary" id="listDiscountsBtn">List All Discounts</button>
                                <hr>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="discountIdInput" placeholder="Enter Discount ID to delete">
                                    <button class="btn btn-danger" id="deleteDiscountBtn">Delete</button>
                                </div>
                                <hr>
                                <h5>Discount List</h5>
                                <div id="discountsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="ads" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Create Ad</h5>
                                <form id="createAdForm">
                                    <div class="mb-3"><input type="text" class="form-control" id="adBrandName" placeholder="Brand Name" required></div>
                                    <div class="mb-3"><input type="url" class="form-control" id="adImageUrl" placeholder="Image URL (e.g., https://...)"></div>
                                    <div class="mb-3"><input type="url" class="form-control" id="adTargetUrl" placeholder="Target URL (e.g., https://...)"></div>
                                    <div class="mb-3"><label class="form-label">Start Date</label><input type="datetime-local" class="form-control" id="adStartDate" required></div>
                                    <div class="mb-3"><label class="form-label">End Date</label><input type="datetime-local" class="form-control" id="adEndDate" required></div>
                                    <button type="submit" class="btn btn-success">Create Ad</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Manage Ads</h5>
                                <button class="btn btn-primary" id="listAdsBtn">List All Ads</button>
                                <hr>
                                <h5>Ads List</h5>
                                <div id="adsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="catalog" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Catalog</h5>
                        <button class="btn btn-primary" id="getCatalogBtn">Get Full Catalog</button>
                        <button class="btn btn-success" id="shareCatalogBtn">Generate Share Link</button>
                        <hr>
                        <h5>Catalog / Share Link</h5>
                        <div id="catalogData"></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="notify" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Send Notification</h5>
                        <form id="sendNotifyForm">
                            <div class="mb-3"><input type="text" class="form-control" id="notifyTitle" placeholder="Notification Title" required></div>
                            <div class="mb-3"><textarea class="form-control" id="notifyBody" placeholder="Notification Body" required></textarea></div>
                            <button type="submit" class="btn btn-info">Send Notification</button>
                        </form>
                    </div>
                </div>
            </div>

        </div> </div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Config & State ---
            const API_BASE_URL = '/store'; // Assuming same-origin deployment. Change to 'https://your-koyeb-app/store' if needed.
            const apiResponseEl = document.getElementById('apiResponse');
            let authToken = localStorage.getItem('authToken') || '';

            if (authToken) {
                document.getElementById('authToken').value = authToken;
            }

            // --- Helpers ---
            function logResponse(data) {
                apiResponseEl.textContent = JSON.stringify(data, null, 2);
            }

            function clearResponse() {
                apiResponseEl.textContent = '...';
            }

            function renderList(elementId, items) {
                const el = document.getElementById(elementId);
                if (!items || items.length === 0) {
                    el.innerHTML = '<p class="text-muted">No items found.</p>';
                    return;
                }
                el.innerHTML = `<ul class="list-group">
                    ${items.map(item => `<li class="list-group-item">
                        <strong>ID:</strong> ${item._id} <br>
                        ${item.name ? `<strong>Name:</strong> ${item.name}` : ''}
                        ${item.customer_name ? `<strong>Customer:</strong> ${item.customer_name}` : ''}
                        ${item.code ? `<strong>Code:</strong> ${item.code}` : ''}
                        ${item.brand_name ? `<strong>Brand:</strong> ${item.brand_name}` : ''}
                        <br><small>${JSON.stringify(item, null, 2)}</small>
                    </li>`).join('')}
                </ul>`;
            }

            async function fetchWithAuth(endpoint, options = {}) {
                clearResponse();
                const headers = { ...options.headers };

                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                // Don't set Content-Type for FormData; browser does it.
                if (!(options.body instanceof FormData) && options.body) {
                    headers['Content-Type'] = 'application/json';
                }

                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        ...options,
                        headers: headers
                    });

                    const data = await response.json();
                    logResponse(data);

                    if (!response.ok) {
                        console.error('API Error:', data);
                    }
                    return data;

                } catch (error) {
                    logResponse({ error: error.message });
                    console.error('Fetch Error:', error);
                }
            }

            // --- Auth ---
            document.getElementById('saveTokenBtn').addEventListener('click', () => {
                authToken = document.getElementById('authToken').value;
                localStorage.setItem('authToken', authToken);
                logResponse({ status: 'Token saved to localStorage' });
            });


            // =========================
            // --- PRODUCTS ---
            // =========================

            // POST /products (Add Product)
            document.getElementById('addProductForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                await fetchWithAuth('/products', {
                    method: 'POST',
                    body: formData
                });
                e.target.reset();
            });

            // GET /products (List Products)
            document.getElementById('listProductsBtn').addEventListener('click', async () => {
                const data = await fetchWithAuth('/products');
                if (data && !data.error) {
                    renderList('productsList', data);
                }
            });

            // GET /products/{product_id}
            document.getElementById('getProductBtn').addEventListener('click', async () => {
                const productId = document.getElementById('productIdInput').value;
                if (!productId) {
                    logResponse({ error: 'Please enter a Product ID' });
                    return;
                }
                const data = await fetchWithAuth(`/products/${productId}`);
                if (data && !data.error) {
                    renderList('productsList', [data]); // Render as a list of one
                }
            });

            // PUT /products/{product_id}
            document.getElementById('updateProductForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const productId = document.getElementById('updateProductId').value;
                if (!productId) {
                    logResponse({ error: 'Please enter a Product ID to update' });
                    return;
                }
                
                const formData = new FormData(e.target);
                // Remove empty fields so they don't overwrite
                for (let [key, value] of new Map(formData)) {
                    if (value === '' || (value instanceof File && value.size === 0)) {
                        formData.delete(key);
                    }
                }

                await fetchWithAuth(`/products/${productId}`, {
                    method: 'PUT',
                    body: formData
                });
            });

            // DELETE /products/{product_id}
            document.getElementById('deleteProductBtn').addEventListener('click', async () => {
                const productId = document.getElementById('productIdInput').value;
                if (!productId) {
                    logResponse({ error: 'Please enter a Product ID' });
                    return;
                }
                if (confirm('Are you sure you want to delete this product?')) {
                    await fetchWithAuth(`/products/${productId}`, {
                        method: 'DELETE'
                    });
                }
            });

            // =========================
            // --- ORDERS ---
            // =========================

            // POST /orders (Create Order)
            document.getElementById('createOrderForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                let products;
                try {
                    products = JSON.parse(document.getElementById('orderProducts').value);
                } catch (err) {
                    logResponse({ error: 'Products JSON is invalid.' });
                    return;
                }
                
                const body = {
                    customer_name: document.getElementById('orderCustomerName').value,
                    customer_email: document.getElementById('orderCustomerEmail').value,
                    customer_phone: document.getElementById('orderCustomerPhone').value,
                    address: document.getElementById('orderAddress').value,
                    products: products
                };

                await fetchWithAuth('/orders', {
                    method: 'POST',
                    body: JSON.stringify(body)
                });
                e.target.reset();
            });

            // GET /orders (List My Orders)
            document.getElementById('listMyOrdersBtn').addEventListener('click', async () => {
                const data = await fetchWithAuth('/orders');
                if (data && !data.error) {
                    renderList('ordersList', data);
                }
            });

            // GET /orders/{order_id}
            document.getElementById('getOrderBtn').addEventListener('click', async () => {
                const orderId = document.getElementById('orderIdInput').value;
                if (!orderId) {
                    logResponse({ error: 'Please enter an Order ID' });
                    return;
                }
                const data = await fetchWithAuth(`/orders/${orderId}`);
                if (data && !data.error) {
                    renderList('ordersList', [data]);
                }
            });

            // POST /orders/{order_id}/update-status
            document.getElementById('updateOrderStatusForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const orderId = document.getElementById('updateStatusOrderId').value;
                const status = document.getElementById('orderStatusSelect').value;
                if (!orderId) {
                    logResponse({ error: 'Please enter an Order ID' });
                    return;
                }
                await fetchWithAuth(`/orders/${orderId}/update-status`, {
                    method: 'POST',
                    body: JSON.stringify({ status: status })
                });
            });

            // POST /orders/{order_id}/generate-bill
            document.getElementById('generateBillBtn').addEventListener('click', async () => {
                const orderId = document.getElementById('orderIdInput').value;
                if (!orderId) {
                    logResponse({ error: 'Please enter an Order ID' });
                    return;
                }
                const data = await fetchWithAuth(`/orders/${orderId}/generate-bill`, {
                    method: 'POST'
                });
                
                if (data && data.qr_code_base64) {
                    document.getElementById('billQrCode').innerHTML = `
                        <h6>Bill for ${data.order_id}</h6>
                        <img src="data:image/png;base64,${data.qr_code_base64}" alt="Order QR Code" class="img-fluid">
                    `;
                }
            });

            // =========================
            // --- DISCOUNTS ---
            // =========================
            
            // POST /discounts
            document.getElementById('addDiscountForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const validUntil = document.getElementById('discountValidUntil').value;
                const body = {
                    code: document.getElementById('discountCode').value,
                    percentage: parseFloat(document.getElementById('discountPercentage').value),
                };
                if (validUntil) {
                    body.valid_until = new Date(validUntil).toISOString();
                }
                await fetchWithAuth('/discounts', {
                    method: 'POST',
                    body: JSON.stringify(body)
                });
                e.target.reset();
            });

            // GET /discounts
            document.getElementById('listDiscountsBtn').addEventListener('click', async () => {
                const data = await fetchWithAuth('/discounts');
                if (data && !data.error) {
                    renderList('discountsList', data);
                }
            });

            // DELETE /discounts/{discount_id}
            document.getElementById('deleteDiscountBtn').addEventListener('click', async () => {
                const discountId = document.getElementById('discountIdInput').value;
                if (!discountId) {
                    logResponse({ error: 'Please enter a Discount ID' });
                    return;
                }
                if (confirm('Are you sure you want to delete this discount?')) {
                    await fetchWithAuth(`/discounts/${discountId}`, {
                        method: 'DELETE'
                    });
                }
            });

            // =========================
            // --- CATALOG ---
            // =========================
            
            // GET /catalog
            document.getElementById('getCatalogBtn').addEventListener('click', async () => {
                const data = await fetchWithAuth('/catalog');
                if (data && data.catalog) {
                    renderList('catalogData', data.catalog);
                }
            });

            // POST /catalog/share
            document.getElementById('shareCatalogBtn').addEventListener('click', async () => {
                const data = await fetchWithAuth('/catalog/share', { method: 'POST' });
                if (data && data.catalog_url) {
                    document.getElementById('catalogData').innerHTML = 
                        `<p class="alert alert-success">Shareable URL: 
                            <a href="${data.catalog_url}" target="_blank">${data.catalog_url}</a>
                        </p>`;
                }
            });

            // =========================
            // --- ADS ---
            // =========================

            // POST /ads
            document.getElementById('createAdForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const body = {
                    brand_name: document.getElementById('adBrandName').value,
                    image_url: document.getElementById('adImageUrl').value || null,
                    target_url: document.getElementById('adTargetUrl').value || null,
                    start_date: new Date(document.getElementById('adStartDate').value).toISOString(),
                    end_date: new Date(document.getElementById('adEndDate').value).toISOString(),
                };
                await fetchWithAuth('/ads', {
                    method: 'POST',
                    body: JSON.stringify(body)
                });
                e.target.reset();
            });

            // GET /ads
            document.getElementById('listAdsBtn').addEventListener('click', async () => {
                const data = await fetchWithAuth('/ads');
                if (data && !data.error) {
                    renderList('adsList', data);
                }
            });

            // =========================
            // --- NOTIFICATIONS ---
            // =========================
            
            // POST /notify
            document.getElementById('sendNotifyForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const body = {
                    title: document.getElementById('notifyTitle').value,
                    body: document.getElementById('notifyBody').value,
                };
                await fetchWithAuth('/notify', {
                    method: 'POST',
                    body: JSON.stringify(body)
                });
                e.target.reset();
            });

        });
    </script>
</body>
</html>